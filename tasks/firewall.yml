---
- name: Handle firewall groups
  vultr.cloud.firewall_group:
    description: "{{ firewall_group.name }}"
    state: "{{ firewall_group.state | default(omit) }}"
    api_key: "{{ vultr__api_key }}"
    api_retries: "{{ vultr__api_retries }}"
    api_retry_max_delay: "{{ vultr__api_retry_max_delay }}"
    api_timeout: "{{ vultr__api_timeout }}"

- name: Handle firewall rules
  vultr.cloud.firewall_rule:
    group: "{{ firewall_group.name }}"
    port: "{{ rule.port }}"
    protocol: "{{ rule.protocol | default('tcp') }}"
    ip_type: "{{ rule.ip_type | default('v6' if rule.cidr is ansible.utils.ipv6 else 'v4') }}"
    subnet: "{{ rule.cidr.split('/')[0] }}"
    subnet_size: "{{ rule.cidr.split('/')[1] }}"
    notes: "{{ rule.notes | default('Generated by ansible') }}"
    state: "{{ rule.state | default(omit) }}"
    api_key: "{{ vultr__api_key }}"
    api_retries: "{{ vultr__api_retries }}"
    api_retry_max_delay: "{{ vultr__api_retry_max_delay }}"
    api_timeout: "{{ vultr__api_timeout }}"
  with_items: "{{ firewall_group.rules | default([]) }}"
  loop_control:
    loop_var: rule
